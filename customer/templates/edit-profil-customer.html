{% extends 'base-pages.html' %}
{% load static %}
{% load custom_filter_form %}
{% load widget_tweaks %}

{% block title %} Mon profil {% endblock %}

{% block content %}
	<section id="hero">
		<svg class="hero-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
		     viewBox="0 24 150 28 " preserveAspectRatio="none">
			<defs>
				<path id="wave-path" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z">
			</defs>
			<g class="wave1">
				<use xlink:href="#wave-path" x="50" y="3" fill="rgba(255,255,255, .1)">
			</g>
			<g class="wave2">
				<use xlink:href="#wave-path" x="50" y="0" fill="rgba(255,255,255, .2)">
			</g>
			<g class="wave3">
				<use xlink:href="#wave-path" x="50" y="9" fill="#fff">
			</g>
		</svg>
	</section>
	<!-- End Hero -->
	<section id="config" class="config min-vh-100 centrage-col-form">
		<div class="row d-flex justify-content-center align-items-center mt-3">
			<div class="text-center py-2">
				<h1 class="title-color">Profile Utilisateur</h1>
				<div class="divider"></div>
				<div class="mt-4">
					<h4 class="mb-4">Modifier mon profil utilisateur</h4>
					<div class="row p-5">
						<form method="POST" enctype="multipart/form-data"
						      action="{% url 'customer:edit_profil_customer' customer.id %}">
							{% csrf_token %}
							<div class="row">
								<div class="col-lg-8 col-md-10 col-sm-12 centrage-col-image">
									<!-- Form image -->
									<div class="form-group text-center">
										{% if customer.image %}
											<img src="{{ customer.image.url }}" alt="image user" width="200">
											<br>
										{% else %}
											<img src="{% static 'images/user-image.png' %}" alt="image user"
											     width="200">
											<br>
										{% endif %}
										<label for="image" class="fs-4">Photo :</label>
										{% if customers.image %}
											{% if customers.image.url %}
												<div class="text-center mb-3">
													<img src="{{ customers.image.url }}" alt="photo-anim"
													     width="200"
													     class="rounded-circle">
												</div>
											{% endif %}
										{% endif %}
										<div class="form-group">
											{{ form.image|add_class:"form-control" }}
										</div>
									</div>
								</div>
							</div>
							<div class="row py-2">
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Nom -->
										<div class="form-group text-start">
										<span class="identify">
										 <i class="bi bi-person-exclamation">
											 <span class="fs-4"> Nom</span>
										 </i>
									 </span>
											<label for="last_name"></label>
											{{ form.last_name }}
											{% for error in form.last_name.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Prénom -->
										<div class="form-group text-start">
										<span class="identify">
										 <i class="bi bi-person-exclamation">
											 <span class="fs-4"> Prénom</span>
										 </i>
									 </span>
											<label for="first_name"></label>
											{{ form.first_name }}
											{% for error in form.first_name.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
							<div class="row py-2">
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Entreprise -->
										<div class="form-group text-start">
											<span class="entreprise">
											    <i class="bi bi-buildings">
													 <span class="fs-4"> Entreprise</span>
											    </i>
										    </span>
											<label for="entreprise"></label>
											{{ form.entreprise }}
											{% for error in form.entreprise.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Mail -->
										<div class="form-group text-start">
											<span class="identify-geo-tel">
												 <i class="bi bi-envelope-at">
													 <span class="fs-4"> Email</span>
												</i>
											</span>
											<label for="mail"></label>
											{{ form.mail }}
											{% for error in form.mail.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
							<div class="row py-2">
								<div class="col-lg-6 col-md-6 col-sm-12">
									<!-- Form Téléphone -->
									<div class="form-account">
										<div class="form-group mt-3">
											<div class="form-group text-start">
																	<span class="identify-geo-tel">
																		 <i class="bi bi-telephone">
																			 <span class="fs-4"> Téléphone</span>
																		</i>
																	 </span>
												<label for="phone"></label>
												{{ form.phone }}
												{% for error in form.phone.errors %}
													<span class="text-danger">{{ error }}</span>
												{% endfor %}
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row py-2">
								<div class="col-lg-6 col-md-6 col-sm-12">
									<!-- Form Adresse -->
									<div class="form-account">
										<div class="form-group">
											<div class="form-group text-start position-relative">
                                                <span class="identify-geo">
                                                  <i class="bi bi-geo">
                                                    <span class="fs-4"> Adresse</span>
                                                  </i>
                                                </span>
												<label for="address" class="visually-hidden">Adresse</label>
												{{ form.address|attr:"id:address"|add_class:"form-control" }}
												<!-- Liste des suggestions -->
												<ul id="address-suggestions" class="list-group"
												    style="position:absolute;top:100%;left:0;right:0;z-index:1050;"></ul>
												{% for error in form.address.errors %}
													<span class="text-danger">{{ error }}</span>
												{% endfor %}
											</div>
										</div>
									</div>
								</div>
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form complement address -->
										<div class="form-group text-start">
											<span class="identify-geo">
                                              <i class="bi bi-geo">
                                                <span class="fs-4"> Complément d'adresse</span>
                                              </i>
                                            </span>

											<label for="complement_address" class="visually-hidden">Complément
												d'adresse</label>
											{{ form.complement_address|attr:"id:complement_address"|add_class:"form-control" }}
											{% for error in form.complement_address.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Ville -->
										<div class="form-group text-start">
										    <span class="identify-geo">
                                              <i class="bi bi-geo">
                                                <span class="fs-4"> Ville</span>
                                              </i>
                                            </span>
											<label for="city" class="visually-hidden">Ville</label>
											{{ form.city|attr:"id:city"|add_class:"form-control" }}
											{% for error in form.city.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
								<div class="col-lg-6 col-md-6 col-sm-12">
									<div class="form-account">
										<!-- Form Code Postal -->
										<div class="form-group text-start">
										    <span class="identify-geo">
                                              <i class="bi bi-geo">
                                                <span class="fs-4"> CP</span>
                                              </i>
                                            </span>
											<label for="zip_code" class="visually-hidden">Code postal</label>
											{{ form.zip_code|attr:"id:zip_code"|add_class:"form-control" }}
											{% for error in form.zip_code.errors %}
												<span class="text-danger">{{ error }}</span>
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
							<!-- Bouton -->
							<div class="text-center mt-4">
								<button type="submit" class="btn-general btn-block">
									Enregistrer
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</section>

	<script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('address');
            const list = document.getElementById('address-suggestions');
            const city = document.getElementById('city');
            const zip = document.getElementById('zip_code');

            // Debounce pour limiter les appels API
            function debounce(fn, delay = 300) {
                let t;
                return (...args) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...args), delay);
                };
            }

            function clearList() {
                list.innerHTML = '';
            }

            function pick(feature) {
                const props = feature.properties;
                input.value = props.label || '';
                if (city) city.value = props.city || props.locality || '';
                if (zip) zip.value = props.postcode || '';
                clearList();
            }

            const onType = debounce(() => {
                const q = (input.value || '').trim();
                if (q.length < 3) {
                    clearList();
                    return;
                }

                fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=5`)
                    .then(r => {
                        if (!r.ok) throw new Error('Erreur API');
                        return r.json();
                    })
                    .then(data => {
                        clearList();
                        const feats = (data && data.features) || [];
                        if (!feats.length) {
                            list.innerHTML = '<li class="list-group-item">Aucune adresse trouvée</li>';
                            return;
                        }
                        feats.forEach(f => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item list-group-item-action';
                            li.style.cursor = 'pointer';
                            li.textContent = f.properties.label;
                            li.addEventListener('click', () => pick(f));
                            list.appendChild(li);
                        });
                    })
                    .catch(() => {
                        list.innerHTML = '<li class="list-group-item">Erreur de recherche. Réessaie.</li>';
                    });
            }, 300);

            input.addEventListener('input', onType);

            // Fermer la liste si clic ailleurs
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) clearList();
            });

            // Empêcher Enter de soumettre le formulaire trop tôt
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') e.preventDefault();
            });
        });
	</script>

{% endblock %}
